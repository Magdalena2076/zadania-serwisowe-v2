<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Zarządzania Zadaniami Serwisowymi</title>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3498db">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-auth-compat.js"></script>

    <!-- Istniejące skrypty -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            text-align: center;
        }
        
        .login-container h2 {
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 10px 15px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .nav-btn:hover, .nav-btn.active {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .select-with-add {
            position: relative;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .select-with-add select {
            flex: 1;
            padding-right: 10px;
        }
        
        /* Style dla wyszukiwarki */
        .select2-container {
            flex: 1;
            width: 100% !important;
        }

        .select2-container--default .select2-selection--single {
            height: 42px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 42px;
            padding-left: 12px;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 40px;
        }

        .select2-dropdown {
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .select2-search--dropdown .select2-search__field {
            padding: 8px;
            border: 1px solid #e1e8ed;
            border-radius: 4px;
        }

        .select2-results__option {
            padding: 8px 12px;
        }

        .select2-container--default .select2-results__option--highlighted[aria-selected] {
            background-color: #3498db;
        }
        
        .add-option-btn {
            position: static;
            transform: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 20px;
            line-height: 32px;
            text-align: center;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }
        
        .add-option-btn:hover {
            background: #2980b9;
            transform: scale(1.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }
        
        .task-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .task-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #3498db;
            transition: transform 0.3s ease;
        }
        
        .task-card:hover {
            transform: translateY(-5px);
        }
        
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-new { background: #e8f4fd; color: #2980b9; }
        .status-open { background: #fff3cd; color: #856404; }
        .status-in-progress { background: #d4edda; color: #155724; }
        .status-on-hold { background: #f8d7da; color: #721c24; }
        .status-completed { background: #d1ecf1; color: #0c5460; }
        .status-closed { background: #e2e3e5; color: #383d41; }
        .status-archived { background: #6c757d; color: white; }
        
        .file-upload {
            border: 2px dashed #bdc3c7;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-upload:hover {
            border-color: #3498db;
            background: #f8f9fa;
        }
        
        .signature-pad {
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            cursor: crosshair;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: relative;
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .close-modal {
            position: absolute;
            right: 10px;
            top: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .close-modal:hover {
            color: #000;
        }
        
        .archived-task {
            opacity: 0.7;
            border-left-color: #6c757d;
        }
        
        .filter-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }
        
        .hidden {
            display: none !important;
        }
        
        .file-item {
            margin: 5px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e9ecef;
        }
        
        .file-item-info {
            flex: 1;
            display: flex;
            align-items: center;
        }
        
        .file-remove-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s ease;
        }
        
        .file-remove-btn:hover {
            background: #c0392b;
        }
        
        .files-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .files-count {
            font-size: 12px;
            color: #666;
            background: #e9ecef;
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        .data-list {
            margin-top: 10px;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .data-item {
            padding: 8px 12px;
            border-bottom: 1px solid #e1e8ed;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .data-item:last-child {
            border-bottom: none;
        }
        
        .delete-item {
            color: #e74c3c;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .delete-item:hover {
            background-color: #fee;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .nav {
                flex-direction: column;
            }
            
            .task-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .content {
                padding: 20px;
            }
            
            .filter-row {
                grid-template-columns: 1fr;
            }
            
            .user-info {
                position: static;
                margin-top: 15px;
                display: inline-block;
            }
        }
    </style>
</head>
<body>
    <!-- Ekran logowania -->
    <div id="login-screen" class="login-container">
        <h2>🔧 System Zarządzania Zadaniami</h2>
        <form id="login-form">
            <div class="form-group">
                <label>Nazwa użytkownika</label>
                <input type="text" id="username" required placeholder="Wprowadź nazwę użytkownika">
            </div>
            <div class="form-group">
                <label>Hasło</label>
                <input type="password" id="password" required placeholder="Wprowadź hasło">
            </div>
            <button type="submit" class="btn btn-success">Zaloguj się</button>
        </form>
        <p style="margin-top: 20px; color: #666; font-size: 12px;">
            Demo: admin/admin123 lub technik/tech123
        </p>
    </div>

    <!-- Główna aplikacja -->
    <div id="main-app" class="container hidden">
        <div class="header">
            <div class="user-info">
                👤 <span id="current-user"></span>
                <button class="logout-btn" onclick="logout()">Wyloguj</button>
            </div>
            <h1>System Zarządzania Zadaniami Serwisowymi</h1>
            <div class="nav">
                <button class="nav-btn active" onclick="showSection('dashboard')">Dashboard</button>
                <button class="nav-btn" onclick="showSection('new-task')">Nowe Zadanie</button>
                <button class="nav-btn" onclick="showSection('tasks')">Lista Zadań</button>
                <button class="nav-btn" onclick="showSection('archive')">Archiwum</button>
                <button class="nav-btn" onclick="showSection('reports')">Raporty</button>
            </div>
        </div>
        
        <div class="content">
            <!-- Dashboard -->
            <div id="dashboard" class="section active">
                <h2>Dashboard</h2>
                <div class="task-grid">
                    <div class="task-card">
                        <h3>📊 Statystyki zadań</h3>
                        <p><strong>Nowe:</strong> <span id="stat-new">0</span></p>
                        <p><strong>W realizacji:</strong> <span id="stat-progress">0</span></p>
                        <p><strong>Zakończone:</strong> <span id="stat-completed">0</span></p>
                        <p><strong>Zarchiwizowane:</strong> <span id="stat-archived">0</span></p>
                    </div>
                    <div class="task-card">
                        <h3>🕒 Ostatnie zadania</h3>
                        <div id="recent-tasks">
                            <!-- Zadania będą dodawane dynamicznie -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Nowe zadanie -->
            <div id="new-task" class="section">
                <h2>Protokół wykonania prac nr. <span id="protocol-number">001/2025</span></h2>
                <form id="task-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Lokalizacja awarii *</label>
                            <div class="select-with-add">
                                <select id="location" required data-type="location" class="select2-search">
                                    <option value="">Wybierz lokalizację</option>
                                </select>
                                <button type="button" class="add-option-btn" onclick="showModal('locationModal')" title="Dodaj nową lokalizację">+</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Technik przydzielony *</label>
                            <div class="select-with-add">
                                <select id="technician" required data-type="technique" class="select2-search">
                                    <option value="">Wybierz technika</option>
                                </select>
                                <button type="button" class="add-option-btn" onclick="showModal('techniqueModal')" title="Dodaj nowego technika">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Data zgłoszenia *</label>
                            <input type="datetime-local" id="report-date" required>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="status">
                                <option value="new">Nowe zadanie</option>
                                <option value="open">Otwarte</option>
                                <option value="in-progress">Realizacja</option>
                                <option value="on-hold">Wstrzymane</option>
                                <option value="completed">Zrealizowane</option>
                                <option value="closed">Zamknięte</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Powód zgłoszenia *</label>
                        <textarea id="reason" rows="3" required placeholder="Opisz problem..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Stwierdzona przyczyna awarii</label>
                        <textarea id="cause" rows="3" placeholder="Do wypełnienia przez technika..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Zrealizowane działania naprawcze</label>
                        <textarea id="actions" rows="3" placeholder="Do wypełnienia przez technika..."></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Godzina przyjazdu</label>
                            <input type="time" id="arrival-time">
                        </div>
                        <div class="form-group">
                            <label>Godzina wyjazdu</label>
                            <input type="time" id="departure-time">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Zużyte materiały</label>
                        <textarea id="materials" rows="3" placeholder="Lista zużytych materiałów..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Uwagi</label>
                        <textarea id="notes" rows="2" placeholder="Dodatkowe uwagi..."></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Osoba wykonująca zadanie</label>
                            <input type="text" id="executor" placeholder="Imię i nazwisko">
                        </div>
                        <div class="form-group">
                            <label>Osoba odbierająca</label>
                            <input type="text" id="receiver" placeholder="Imię i nazwisko">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="files-header">
                            <label>Załączniki</label>
                            <span class="files-count" id="files-count">0 plików</span>
                        </div>
                        <div class="file-upload" onclick="document.getElementById('files').click()">
                            <p>📎 Kliknij aby dodać zdjęcia lub dokumenty</p>
                            <input type="file" id="files" multiple accept="image/*,.pdf,.doc,.docx" style="display: none;">
                        </div>
                        <div id="file-list"></div>
                        <button type="button" class="btn btn-warning" onclick="clearAllFiles()" style="margin-top: 10px; font-size: 12px; padding: 5px 15px; display: none;" id="clear-files-btn">🗑️ Usuń wszystkie załączniki</button>
                    </div>
                    
                    <div class="form-group">
                        <label>Podpis elektroniczny</label>
                        <canvas id="signature" class="signature-pad" width="400" height="150"></canvas>
                        <button type="button" class="btn" onclick="clearSignature()">Wyczyść podpis</button>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <button type="submit" class="btn btn-success">💾 Zapisz zadanie</button>
                        <button type="button" class="btn" onclick="generateTaskPDF()">📄 Generuj PDF</button>
                        <button type="button" class="btn btn-danger" onclick="cancelEdit()" style="display: none;">❌ Anuluj edycję</button>
                        <button type="reset" class="btn btn-danger">🗑️ Wyczyść formularz</button>
                    </div>
                </form>
            </div>
            
            <!-- Lista zadań -->
            <div id="tasks" class="section">
                <h2>Lista zadań</h2>
                
                <div class="filter-section">
                    <h3>🔍 Filtry</h3>
                    <div class="filter-row">
                        <div class="form-group">
                            <label>Status</label>
                            <select id="filter-status" onchange="applyFilters()">
                                <option value="">Wszystkie</option>
                                <option value="new">Nowe</option>
                                <option value="open">Otwarte</option>
                                <option value="in-progress">W realizacji</option>
                                <option value="on-hold">Wstrzymane</option>
                                <option value="completed">Zakończone</option>
                                <option value="closed">Zamknięte</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Technik</label>
                            <select id="filter-technician" onchange="applyFilters()">
                                <option value="">Wszyscy</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Lokalizacja</label>
                            <select id="filter-location" onchange="applyFilters()">
                                <option value="">Wszystkie</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-warning" onclick="clearFilters()">Wyczyść filtry</button>
                        </div>
                    </div>
                </div>
                
                <div id="tasks-list" class="task-grid">
                    <!-- Zadania będą dodawane dynamicznie -->
                </div>
            </div>
            
            <!-- Archiwum -->
            <div id="archive" class="section">
                <h2>📚 Archiwum zadań</h2>
                <div id="archive-list" class="task-grid">
                    <!-- Zarchiwizowane zadania -->
                </div>
            </div>
            
            <!-- Raporty -->
            <div id="reports" class="section">
                <h2>📊 Raporty</h2>
                <div class="task-card">
                    <h3>Generuj raport</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Data od</label>
                            <input type="date" id="report-from">
                        </div>
                        <div class="form-group">
                            <label>Data do</label>
                            <input type="date" id="report-to">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Typ raportu</label>
                        <select id="report-type">
                            <option value="summary">Podsumowanie</option>
                            <option value="detailed">Szczegółowy</option>
                            <option value="by-technician">Według technika</option>
                            <option value="by-location">Według lokalizacji</option>
                        </select>
                    </div>
                    <button class="btn" onclick="generateReport()">📊 Generuj raport PDF</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal dla nowej lokalizacji -->
    <div id="locationModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('locationModal')">&times;</span>
            <h3>Dodaj nową lokalizację</h3>
            <div class="form-group">
                <input type="text" id="newLocation" placeholder="Wprowadź nową lokalizację">
                <button class="btn" onclick="addNewLocation()">Dodaj</button>
            </div>
            <div class="data-list" id="locationsList"></div>
        </div>
    </div>

    <!-- Modal dla nowej techniki -->
    <div id="techniqueModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('techniqueModal')">&times;</span>
            <h3>Dodaj nową technikę</h3>
            <div class="form-group">
                <input type="text" id="newTechnique" placeholder="Wprowadź nową technikę">
                <button class="btn" onclick="addNewTechnique()">Dodaj</button>
            </div>
            <div class="data-list" id="techniquesList"></div>
        </div>
    </div>

    <script>
        // Dane aplikacji
        let currentUser = null;
        let tasks = [];
        let archivedTasks = [];
        let taskCounter = 1;
        let isDrawing = false;
        let canvas, ctx;
        let currentEditingTask = null;
        let currentSelectId = null;
        
        // Przechowywanie załączników - NOWA FUNKCJONALNOŚĆ
        let attachedFiles = [];
        
        // Domyślne opcje
        let locations = [
            'Budynek A - Parter',
            'Budynek A - I piętro',
            'Budynek B - Piwnica',
            'Budynek B - Parter',
            'Teren zewnętrzny',
            'Parking',
            'Magazyn'
        ];
        
        let technicians = [
            'Jan Kowalski',
            'Anna Nowak',
            'Piotr Wiśniewski',
            'Maria Wójcik',
            'Tomasz Krawczyk'
        ];
        
        // Użytkownicy (w prawdziwej aplikacji byłoby w bazie danych)
        const users = {
            'admin': { password: 'admin123', role: 'administrator', name: 'Administrator' },
            'technik': { password: 'tech123', role: 'technik', name: 'Technik Jan' },
            'manager': { password: 'manager123', role: 'manager', name: 'Manager Anna' }
        };
        
        // Przykładowe zadania
        const sampleTasks = [
            {
                id: 1,
                protocolNumber: '001/2025',
                location: 'Budynek A - Parter',
                technician: 'Jan Kowalski',
                reportDate: '2025-05-20T10:00',
                status: 'completed',
                reason: 'Awaria instalacji elektrycznej',
                cause: 'Uszkodzony przewód',
                actions: 'Wymiana uszkodzonego przewodu',
                createdBy: 'admin',
                createdAt: new Date('2025-05-20T10:00').toISOString()
            },
            {
                id: 2,
                protocolNumber: '002/2025',
                location: 'Budynek B - Piwnica',
                technician: 'Anna Nowak',
                reportDate: '2025-05-21T14:30',
                status: 'in-progress',
                reason: 'Problem z wentylacją',
                cause: 'Zatkany filtr',
                actions: 'Czyszczenie systemu wentylacji',
                createdBy: 'admin',
                createdAt: new Date('2025-05-21T14:30').toISOString()
            }
        ];
        
        // Inicjalizacja
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        
        function initializeApp() {
            // Wczytaj zapisane zadania
            loadTasksFromStorage();
            
            // Inicjalizacja domyślnych lokalizacji jeśli nie istnieją
            if (!localStorage.getItem('locations')) {
                const defaultLocations = [
                    'Budynek A - Parter',
                    'Budynek A - I piętro',
                    'Budynek B - Piwnica',
                    'Budynek B - Parter',
                    'Teren zewnętrzny',
                    'Parking',
                    'Magazyn'
                ];
                localStorage.setItem('locations', JSON.stringify(defaultLocations));
            }

            // Inicjalizacja domyślnych techników jeśli nie istnieją
            if (!localStorage.getItem('techniques')) {
                const defaultTechnicians = [
                    'Jan Kowalski',
                    'Anna Nowak',
                    'Piotr Wiśniewski',
                    'Maria Wójcik',
                    'Tomasz Krawczyk'
                ];
                localStorage.setItem('techniques', JSON.stringify(defaultTechnicians));
            }
            
            // Sprawdź czy użytkownik jest zalogowany
            if (currentUser) {
                showMainApp();
            } else {
                showLoginScreen();
            }
            
            // Event listenery
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('task-form').addEventListener('submit', handleSubmit);
            document.getElementById('files').addEventListener('change', handleFiles);
            
            // Inicjalizacja canvas
            canvas = document.getElementById('signature');
            if (canvas) {
                ctx = canvas.getContext('2d');
                setupSignaturePad();
            }
            
            // Aktualizuj listy wyboru
            updateLocationSelects();
            updateTechniqueSelects();
            
            // Inicjalizacja Select2
            initializeSelects();
        }
        
        function showLoginScreen() {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
        }
        
        function showMainApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('current-user').textContent = currentUser.name;
            document.getElementById('report-date').value = new Date().toISOString().slice(0, 16);
            updateProtocolNumber();
        }
        
        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (users[username] && users[username].password === password) {
                currentUser = {
                    username: username,
                    name: users[username].name,
                    role: users[username].role
                };
                // Zapisanie tylko w pamięci sesji (bez localStorage)
                showMainApp();
            } else {
                alert('❌ Nieprawidłowa nazwa użytkownika lub hasło!');
            }
        }
        
        function logout() {
            currentUser = null;
            // Wyczyść formularz i dane
            document.getElementById('task-form').reset();
            clearSignature();
            clearAllFiles();
            showLoginScreen();
        }
        
        function updateSelects() {
            // Aktualizuj lokalizacje
            const locationSelect = document.getElementById('location');
            const filterLocationSelect = document.getElementById('filter-location');
            
            locationSelect.innerHTML = '<option value="">Wybierz lokalizację</option>';
            filterLocationSelect.innerHTML = '<option value="">Wszystkie</option>';
            
            locations.forEach(location => {
                locationSelect.innerHTML += `<option value="${location}">${location}</option>`;
                filterLocationSelect.innerHTML += `<option value="${location}">${location}</option>`;
            });
            
            // Aktualizuj techników
            const technicianSelect = document.getElementById('technician');
            const filterTechnicianSelect = document.getElementById('filter-technician');
            
            technicianSelect.innerHTML = '<option value="">Wybierz technika</option>';
            filterTechnicianSelect.innerHTML = '<option value="">Wszyscy</option>';
            
            technicians.forEach(technician => {
                technicianSelect.innerHTML += `<option value="${technician}">${technician}</option>`;
                filterTechnicianSelect.innerHTML += `<option value="${technician}">${technician}</option>`;
            });
        }
        
        function addNewOption(selectId) {
            currentSelectId = selectId;
            const modal = document.getElementById('add-option-modal');
            const title = document.getElementById('modal-title');
            
            if (selectId === 'location') {
                title.textContent = 'Dodaj nową lokalizację';
            } else if (selectId === 'technician') {
                title.textContent = 'Dodaj nowego technika';
            }
            
            modal.style.display = 'block';
            document.getElementById('new-option-input').focus();
        }
        
        function closeModal() {
            document.getElementById('add-option-modal').style.display = 'none';
            document.getElementById('new-option-input').value = '';
            currentSelectId = null;
        }
        
        function saveNewOption() {
            const newValue = document.getElementById('new-option-input').value.trim();
            
            if (!newValue) {
                alert('Proszę wprowadzić wartość!');
                return;
            }
            
            if (currentSelectId === 'location') {
                if (!locations.includes(newValue)) {
                    locations.push(newValue);
                    updateSelects();
                    document.getElementById('location').value = newValue;
                }
            } else if (currentSelectId === 'technician') {
                if (!technicians.includes(newValue)) {
                    technicians.push(newValue);
                    updateSelects();
                    document.getElementById('technician').value = newValue;
                }
            }
            
            closeModal();
        }
        
        function updateProtocolNumber() {
            const year = new Date().getFullYear();
            const number = String(taskCounter).padStart(3, '0');
            document.getElementById('protocol-number').textContent = `${number}/${year}`;
        }
        
        function setupSignaturePad() {
            if (!canvas || !ctx) return;
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events dla urządzeń mobilnych
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
        }
        
        function startDrawing(e) {
            isDrawing = true;
            draw(e);
        }
        
        function draw(e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000';
            
            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
        }
        
        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                ctx.beginPath();
            }
        }
        
        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                            e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }
        
        function clearSignature() {
            if (ctx && canvas) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }
        
        // NOWE FUNKCJE OBSŁUGI ZAŁĄCZNIKÓW
        function handleFiles(e) {
            const files = e.target.files;
            
            // Dodaj nowe pliki do istniejących
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                // Sprawdź czy plik już nie istnieje (unikaj duplikatów)
                const existingFile = attachedFiles.find(f => f.name === file.name && f.size === file.size);
                if (!existingFile) {
                    attachedFiles.push({
                        file: file,
                        name: file.name,
                        size: file.size,
                        id: Date.now() + Math.random() // Unikalny ID
                    });
                }
            }
            
            // Wyczyść input aby umożliwić ponowne dodanie tego samego pliku
            e.target.value = '';
            
            // Odśwież listę
            updateFileList();
        }
        
        function updateFileList() {
            const fileList = document.getElementById('file-list');
            const filesCount = document.getElementById('files-count');
            const clearBtn = document.getElementById('clear-files-btn');
            
            fileList.innerHTML = '';
            filesCount.textContent = `${attachedFiles.length} ${attachedFiles.length === 1 ? 'plik' : 'plików'}`;
            
            if (attachedFiles.length === 0) {
                clearBtn.style.display = 'none';
                return;
            }
            
            clearBtn.style.display = 'inline-block';
            
            attachedFiles.forEach((fileData, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                fileItem.innerHTML = `
                    <div class="file-item-info">
                        <span>📎 ${fileData.name} (${(fileData.size / 1024).toFixed(1)} KB)</span>
                    </div>
                    <button type="button" onclick="removeFile(${index})" class="file-remove-btn" title="Usuń plik">
                        🗑️ Usuń
                    </button>
                `;
                fileList.appendChild(fileItem);
            });
        }
        
        function removeFile(index) {
            if (confirm('Czy na pewno chcesz usunąć ten załącznik?')) {
                attachedFiles.splice(index, 1);
                updateFileList();
            }
        }
        
        function clearAllFiles() {
            if (attachedFiles.length === 0) return;
            
            if (confirm('Czy na pewno chcesz usunąć wszystkie załączniki?')) {
                attachedFiles = [];
                updateFileList();
            }
        }
        
        function handleSubmit(e) {
            e.preventDefault();
            
            const task = {
                id: currentEditingTask ? currentEditingTask.id : Date.now(),
                protocolNumber: currentEditingTask ? currentEditingTask.protocolNumber : document.getElementById('protocol-number').textContent,
                location: document.getElementById('location').value,
                technician: document.getElementById('technician').value,
                reportDate: document.getElementById('report-date').value,
                status: document.getElementById('status').value,
                reason: document.getElementById('reason').value,
                cause: document.getElementById('cause').value,
                actions: document.getElementById('actions').value,
                arrivalTime: document.getElementById('arrival-time').value,
                departureTime: document.getElementById('departure-time').value,
                materials: document.getElementById('materials').value,
                notes: document.getElementById('notes').value,
                executor: document.getElementById('executor').value,
                receiver: document.getElementById('receiver').value,
                files: attachedFiles.map(f => f.name),
                signature: canvas ? canvas.toDataURL() : null,
                createdBy: currentEditingTask ? currentEditingTask.createdBy : currentUser.username,
                createdAt: currentEditingTask ? currentEditingTask.createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (currentEditingTask) {
                // Edycja istniejącego zadania
                const index = tasks.findIndex(t => t.id === currentEditingTask.id);
                if (index !== -1) {
                    tasks[index] = task;
                }
                alert('✅ Zadanie zostało zapisane!');
                currentEditingTask = null;
                
                // Przywróć oryginalny wygląd formularza
                resetFormAfterEdit();
                
                // Zapisz do localStorage
                saveTasksToStorage();
                
                // Przejdź do listy zadań
                showSection('tasks');
            } else {
                // Nowe zadanie
                tasks.push(task);
                taskCounter++;
                updateProtocolNumber();
                
                // Zapisz do localStorage
                saveTasksToStorage();
                
                alert('✅ Nowe zadanie zostało utworzone!');
                
                // Wyczyść formularz
                document.getElementById('task-form').reset();
                clearSignature();
                silentClearFiles(); // Używamy cichego czyszczenia
                document.getElementById('report-date').value = new Date().toISOString().slice(0, 16);
            }
            
            // Aktualizuj interfejs
            updateDashboard();
            updateTasksList();
        }
        
        function resetFormAfterEdit() {
            // Przywróć oryginalny nagłówek
            document.querySelector('#new-task h2').innerHTML = `Protokół wykonania prac nr. <span id="protocol-number"></span>`;
            
            // Przywróć oryginalny przycisk zapisu
            const submitBtn = document.querySelector('#task-form button[type="submit"]');
            submitBtn.innerHTML = '💾 Zapisz zadanie';
            submitBtn.className = 'btn btn-success';
            
            // Ukryj przycisk anulowania
            const cancelBtn = document.querySelector('button[onclick="cancelEdit()"]');
            cancelBtn.style.display = 'none';
            
            // Wyczyść formularz
            document.getElementById('task-form').reset();
            clearSignature();
            silentClearFiles(); // Używamy cichego czyszczenia
            document.getElementById('report-date').value = new Date().toISOString().slice(0, 16);
            updateProtocolNumber();
        }
        
        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            currentEditingTask = task;
            
            // Aktualizuj nagłówek formularza
            document.querySelector('#new-task h2').innerHTML = `Edycja zadania - Protokół nr. <span id="protocol-number">${task.protocolNumber}</span>`;
            
            // Aktualizuj przycisk zapisu
            const submitBtn = document.querySelector('#task-form button[type="submit"]');
            submitBtn.innerHTML = '💾 Zapisz';
            submitBtn.className = 'btn btn-success';
            
            // Pokaż przycisk anulowania
            const cancelBtn = document.querySelector('button[onclick="cancelEdit()"]');
            cancelBtn.style.display = 'inline-block';
            
            // Wypełnij formularz
            document.getElementById('location').value = task.location || '';
            document.getElementById('technician').value = task.technician || '';
            document.getElementById('report-date').value = task.reportDate || '';
            document.getElementById('status').value = task.status || '';
            document.getElementById('reason').value = task.reason || '';
            document.getElementById('cause').value = task.cause || '';
            document.getElementById('actions').value = task.actions || '';
            document.getElementById('arrival-time').value = task.arrivalTime || '';
            document.getElementById('departure-time').value = task.departureTime || '';
            document.getElementById('materials').value = task.materials || '';
            document.getElementById('notes').value = task.notes || '';
            document.getElementById('executor').value = task.executor || '';
            document.getElementById('receiver').value = task.receiver || '';
            
            // Wyczyść obecne załączniki i załaduj z zadania
            attachedFiles = [];
            if (task.files && task.files.length > 0) {
                task.files.forEach((fileName, index) => {
                    attachedFiles.push({
                        name: fileName,
                        size: 1024,
                        id: Date.now() + index
                    });
                });
            }
            updateFileList();
            
            // Przejdź do sekcji edycji
            showSection('new-task');
            
            alert('📝 Zadanie załadowane do edycji');
        }
        
        function updateDashboard() {
            const stats = {
                new: tasks.filter(t => t.status === 'new').length,
                progress: tasks.filter(t => t.status === 'in-progress').length,
                completed: tasks.filter(t => t.status === 'completed').length,
                archived: archivedTasks.length
            };
            
            document.getElementById('stat-new').textContent = stats.new;
            document.getElementById('stat-progress').textContent = stats.progress;
            document.getElementById('stat-completed').textContent = stats.completed;
            document.getElementById('stat-archived').textContent = stats.archived;
            
            // Ostatnie zadania
            const recentTasks = tasks.slice(-3).reverse();
            const recentTasksDiv = document.getElementById('recent-tasks');
            recentTasksDiv.innerHTML = '';
            
            if (recentTasks.length === 0) {
                recentTasksDiv.innerHTML = '<p>Brak zadań</p>';
            } else {
                recentTasks.forEach(task => {
                    const taskItem = document.createElement('div');
                    taskItem.style.margin = '10px 0';
                    taskItem.style.padding = '10px';
                    taskItem.style.background = '#f8f9fa';
                    taskItem.style.borderRadius = '5px';
                    taskItem.innerHTML = `
                        <strong>${task.protocolNumber}</strong><br>
                        <small>${task.location} - ${getStatusText(task.status)}</small>
                    `;
                    recentTasksDiv.appendChild(taskItem);
                });
            }
        }
        
        function updateTasksList() {
            const tasksList = document.getElementById('tasks-list');
            const filteredTasks = getFilteredTasks();
            
            tasksList.innerHTML = '';
            
            if (filteredTasks.length === 0) {
                tasksList.innerHTML = '<div class="task-card"><p>Brak zadań do wyświetlenia</p></div>';
                return;
            }
            
            filteredTasks.forEach(task => {
                const taskCard = createTaskCard(task);
                tasksList.appendChild(taskCard);
            });
        }
        
        function updateArchiveList() {
            const archiveList = document.getElementById('archive-list');
            archiveList.innerHTML = '';
            
            if (archivedTasks.length === 0) {
                archiveList.innerHTML = '<div class="task-card"><p>Brak zarchiwizowanych zadań</p></div>';
                return;
            }
            
            archivedTasks.forEach(task => {
                const taskCard = createTaskCard(task, true);
                archiveList.appendChild(taskCard);
            });
        }
        
        function createTaskCard(task, isArchived = false) {
            const taskCard = document.createElement('div');
            taskCard.className = `task-card ${isArchived ? 'archived-task' : ''}`;
            
            taskCard.innerHTML = `
                <h3>${task.protocolNumber}</h3>
                <p><strong>Lokalizacja:</strong> ${task.location}</p>
                <p><strong>Technik:</strong> ${task.technician}</p>
                <p><strong>Data:</strong> ${new Date(task.reportDate).toLocaleString('pl-PL')}</p>
                <p><strong>Status:</strong> <span class="status status-${task.status}">${getStatusText(task.status)}</span></p>
                <p><strong>Powód:</strong> ${task.reason}</p>
                ${task.cause ? `<p><strong>Przyczyna:</strong> ${task.cause}</p>` : ''}
                ${task.actions ? `<p><strong>Działania:</strong> ${task.actions}</p>` : ''}
                ${task.files && task.files.length > 0 ? `<p><strong>Załączniki:</strong> ${task.files.length} ${task.files.length === 1 ? 'plik' : 'plików'}</p>` : ''}
                <div style="margin-top: 15px;">
                    ${!isArchived ? `
                        <button class="btn" onclick="editTask(${task.id})">✏️ Edytuj</button>
                        <button class="btn btn-warning" onclick="archiveTask(${task.id})">📚 Archiwizuj</button>
                    ` : `
                        <button class="btn" onclick="restoreTask(${task.id})">↩️ Przywróć</button>
                    `}
                    <button class="btn" onclick="generateTaskPDF(${task.id})">📄 PDF</button>
                    <button class="btn btn-danger" onclick="deleteTask(${task.id}, ${isArchived})">🗑️ Usuń</button>
                </div>
            `;
            
            return taskCard;
        }
        
        function getStatusText(status) {
            const statusTexts = {
                'new': 'Nowe',
                'open': 'Otwarte',
                'in-progress': 'W realizacji',
                'on-hold': 'Wstrzymane',
                'completed': 'Zakończone',
                'closed': 'Zamknięte',
                'archived': 'Zarchiwizowane'
            };
            return statusTexts[status] || status;
        }
        
        function archiveTask(taskId) {
            if (!confirm('Czy na pewno chcesz zarchiwizować to zadanie?')) return;
            
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex !== -1) {
                const task = tasks[taskIndex];
                task.status = 'archived';
                task.archivedAt = new Date().toISOString();
                
                archivedTasks.push(task);
                tasks.splice(taskIndex, 1);
                
                // Zapisz zmiany do localStorage
                saveTasksToStorage();
                
                updateDashboard();
                updateTasksList();
                updateArchiveList();
                
                alert('📚 Zadanie zostało zarchiwizowane');
            }
        }
        
        function restoreTask(taskId) {
            if (!confirm('Czy na pewno chcesz przywrócić to zadanie?')) return;
            
            const taskIndex = archivedTasks.findIndex(t => t.id === taskId);
            if (taskIndex !== -1) {
                const task = archivedTasks[taskIndex];
                task.status = 'open';
                delete task.archivedAt;
                
                tasks.push(task);
                archivedTasks.splice(taskIndex, 1);
                
                // Zapisz zmiany do localStorage
                saveTasksToStorage();
                
                updateDashboard();
                updateTasksList();
                updateArchiveList();
                
                alert('↩️ Zadanie zostało przywrócone');
            }
        }
        
        function deleteTask(taskId, isArchived) {
            if (!confirm('Czy na pewno chcesz usunąć to zadanie? Ta operacja jest nieodwracalna!')) return;
            
            if (isArchived) {
                const taskIndex = archivedTasks.findIndex(t => t.id === taskId);
                if (taskIndex !== -1) {
                    archivedTasks.splice(taskIndex, 1);
                    updateArchiveList();
                }
            } else {
                const taskIndex = tasks.findIndex(t => t.id === taskId);
                if (taskIndex !== -1) {
                    tasks.splice(taskIndex, 1);
                    updateTasksList();
                }
            }
            
            updateDashboard();
            alert('🗑️ Zadanie zostało usunięte');
        }
        
        function cancelEdit() {
            if (currentEditingTask && confirm('Czy na pewno chcesz anulować edycję? Niezapisane zmiany zostaną utracone.')) {
                currentEditingTask = null;
                
                // Przywróć oryginalny nagłówek i przycisk
                document.querySelector('#new-task h2').innerHTML = `Protokół wykonania prac nr. <span id="protocol-number"></span>`;
                const submitBtn = document.querySelector('#task-form button[type="submit"]');
                submitBtn.innerHTML = '💾 Zapisz zadanie';
                submitBtn.className = 'btn btn-success';
                
                // Wyczyść formularz
                document.getElementById('task-form').reset();
                clearSignature();
                silentClearFiles(); // Używamy cichego czyszczenia
                document.getElementById('report-date').value = new Date().toISOString().slice(0, 16);
                updateProtocolNumber();
                
                alert('✅ Edycja została anulowana');
            }
        }
        
        function getFilteredTasks() {
            const statusFilter = document.getElementById('filter-status').value;
            const technicianFilter = document.getElementById('filter-technician').value;
            const locationFilter = document.getElementById('filter-location').value;
            
            return tasks.filter(task => {
                const statusMatch = !statusFilter || task.status === statusFilter;
                const technicianMatch = !technicianFilter || task.technician === technicianFilter;
                const locationMatch = !locationFilter || task.location === locationFilter;
                
                return statusMatch && technicianMatch && locationMatch;
            });
        }
        
        function applyFilters() {
            updateTasksList();
        }
        
        function clearFilters() {
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-technician').value = '';
            document.getElementById('filter-location').value = '';
            updateTasksList();
        }
        
        function showSection(sectionName) {
            // Ukryj wszystkie sekcje
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Pokaż wybraną sekcję
            document.getElementById(sectionName).classList.add('active');
            
            // Aktualizuj nawigację
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            event.target.classList.add('active');
            
            // Reset edycji zadania przy przejściu do nowego zadania
            if (sectionName === 'new-task' && !currentEditingTask) {
                // Przywróć oryginalny nagłówek i przycisk dla nowego zadania
                document.querySelector('#new-task h2').innerHTML = `Protokół wykonania prac nr. <span id="protocol-number"></span>`;
                const submitBtn = document.querySelector('#task-form button[type="submit"]');
                submitBtn.innerHTML = '💾 Zapisz zadanie';
                submitBtn.className = 'btn btn-success';
                
                // Ukryj przycisk anulowania
                const cancelBtn = document.querySelector('button[onclick="cancelEdit()"]');
                cancelBtn.style.display = 'none';
                
                document.getElementById('task-form').reset();
                clearSignature();
                silentClearFiles(); // Używamy cichego czyszczenia
                document.getElementById('report-date').value = new Date().toISOString().slice(0, 16);
                updateProtocolNumber();
            }
            
            // Reinicjalizuj Select2 po przejściu do sekcji nowego zadania
            if (sectionName === 'new-task') {
                initializeSelects();
            }
        }
        
        function generateTaskPDF(taskId = null) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let task;
            if (taskId) {
                task = tasks.find(t => t.id === taskId) || archivedTasks.find(t => t.id === taskId);
            } else {
                // Pobierz dane z formularza
                task = {
                    protocolNumber: document.getElementById('protocol-number').textContent,
                    location: document.getElementById('location').value,
                    technician: document.getElementById('technician').value,
                    reportDate: document.getElementById('report-date').value,
                    status: document.getElementById('status').value,
                    reason: document.getElementById('reason').value,
                    cause: document.getElementById('cause').value,
                    actions: document.getElementById('actions').value,
                    arrivalTime: document.getElementById('arrival-time').value,
                    departureTime: document.getElementById('departure-time').value,
                    materials: document.getElementById('materials').value,
                    notes: document.getElementById('notes').value,
                    executor: document.getElementById('executor').value,
                    receiver: document.getElementById('receiver').value,
                    files: attachedFiles.map(f => f.name)
                };
            }
            
            if (!task) {
                alert('❌ Nie znaleziono zadania');
                return;
            }
            
            // Nagłówek
            doc.setFontSize(16);
            doc.text('PROTOKÓŁ WYKONANIA PRAC SERWISOWYCH', 20, 20);
            
            doc.setFontSize(12);
            doc.text(`Nr protokołu: ${task.protocolNumber}`, 20, 35);
            
            let y = 50;
            const lineHeight = 7;
            
            // Dane podstawowe
            doc.text(`Lokalizacja: ${task.location || ''}`, 20, y);
            y += lineHeight;
            doc.text(`Technik: ${task.technician || ''}`, 20, y);
            y += lineHeight;
            doc.text(`Data zgłoszenia: ${task.reportDate ? new Date(task.reportDate).toLocaleString('pl-PL') : ''}`, 20, y);
            y += lineHeight;
            doc.text(`Status: ${getStatusText(task.status)}`, 20, y);
            y += lineHeight * 2;
            
            // Powód zgłoszenia
            doc.text('Powód zgłoszenia:', 20, y);
            y += lineHeight;
            const reasonLines = doc.splitTextToSize(task.reason || '', 170);
            doc.text(reasonLines, 20, y);
            y += lineHeight * reasonLines.length + lineHeight;
            
            // Przyczyna awarii
            if (task.cause) {
                doc.text('Stwierdzona przyczyna awarii:', 20, y);
                y += lineHeight;
                const causeLines = doc.splitTextToSize(task.cause, 170);
                doc.text(causeLines, 20, y);
                y += lineHeight * causeLines.length + lineHeight;
            }
            
            // Działania naprawcze
            if (task.actions) {
                doc.text('Zrealizowane działania naprawcze:', 20, y);
                y += lineHeight;
                const actionsLines = doc.splitTextToSize(task.actions, 170);
                doc.text(actionsLines, 20, y);
                y += lineHeight * actionsLines.length + lineHeight;
            }
            
            // Godziny
            if (task.arrivalTime || task.departureTime) {
                doc.text(`Godzina przyjazdu: ${task.arrivalTime || ''}`, 20, y);
                doc.text(`Godzina wyjazdu: ${task.departureTime || ''}`, 120, y);
                y += lineHeight * 2;
            }
            
            // Materiały
            if (task.materials) {
                doc.text('Zużyte materiały:', 20, y);
                y += lineHeight;
                const materialsLines = doc.splitTextToSize(task.materials, 170);
                doc.text(materialsLines, 20, y);
                y += lineHeight * materialsLines.length + lineHeight;
            }
            
            // Załączniki
            if (task.files && task.files.length > 0) {
                doc.text(`Załączniki (${task.files.length}):`, 20, y);
                y += lineHeight;
                task.files.forEach(fileName => {
                    doc.text(`• ${fileName}`, 25, y);
                    y += lineHeight;
                });
                y += lineHeight;
            }
            
            // Uwagi
            if (task.notes) {
                doc.text('Uwagi:', 20, y);
                y += lineHeight;
                const notesLines = doc.splitTextToSize(task.notes, 170);
                doc.text(notesLines, 20, y);
                y += lineHeight * notesLines.length + lineHeight;
            }
            
            // Podpisy
            y += lineHeight;
            doc.text(`Osoba wykonująca: ${task.executor || '___________________'}`, 20, y);
            y += lineHeight * 3;
            doc.text(`Osoba odbierająca: ${task.receiver || '___________________'}`, 20, y);
            
            // Stopka
            y = 280;
            doc.setFontSize(10);
            doc.text(`Wygenerowano: ${new Date().toLocaleString('pl-PL')}`, 20, y);
            doc.text(`Utworzone przez: ${currentUser.name}`, 120, y);
            
            // Zapisz PDF
            doc.save(`protokol_${task.protocolNumber?.replace('/', '_') || 'nowy'}.pdf`);
        }
        
        function generateReport() {
            const fromDate = document.getElementById('report-from').value;
            const toDate = document.getElementById('report-to').value;
            const reportType = document.getElementById('report-type').value;
            
            if (!fromDate || !toDate) {
                alert('❌ Proszę wybrać zakres dat!');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Filtruj zadania według dat
            const filteredTasks = tasks.filter(task => {
                const taskDate = new Date(task.reportDate);
                const from = new Date(fromDate);
                const to = new Date(toDate);
                return taskDate >= from && taskDate <= to;
            });
            
            // Nagłówek raportu
            doc.setFontSize(16);
            doc.text('RAPORT ZADAŃ SERWISOWYCH', 20, 20);
            
            doc.setFontSize(12);
            doc.text(`Okres: ${fromDate} - ${toDate}`, 20, 35);
            doc.text(`Typ raportu: ${getReportTypeText(reportType)}`, 20, 45);
            
            let y = 60;
            const lineHeight = 7;
            
            if (reportType === 'summary') {
                // Raport podsumowujący
                const stats = {
                    total: filteredTasks.length,
                    new: filteredTasks.filter(t => t.status === 'new').length,
                    inProgress: filteredTasks.filter(t => t.status === 'in-progress').length,
                    completed: filteredTasks.filter(t => t.status === 'completed').length,
                    closed: filteredTasks.filter(t => t.status === 'closed').length
                };
                
                doc.text('PODSUMOWANIE:', 20, y);
                y += lineHeight * 2;
                doc.text(`Łączna liczba zadań: ${stats.total}`, 20, y);
                y += lineHeight;
                doc.text(`Nowe zadania: ${stats.new}`, 20, y);
                y += lineHeight;
                doc.text(`W realizacji: ${stats.inProgress}`, 20, y);
                y += lineHeight;
                doc.text(`Zakończone: ${stats.completed}`, 20, y);
                y += lineHeight;
                doc.text(`Zamknięte: ${stats.closed}`, 20, y);
                
            } else if (reportType === 'detailed') {
                // Raport szczegółowy
                doc.text('LISTA ZADAŃ:', 20, y);
                y += lineHeight * 2;
                
                filteredTasks.forEach((task, index) => {
                    if (y > 250) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    doc.text(`${index + 1}. ${task.protocolNumber} - ${task.location}`, 20, y);
                    y += lineHeight;
                    doc.text(`   Technik: ${task.technician}, Status: ${getStatusText(task.status)}`, 20, y);
                    y += lineHeight;
                    doc.text(`   Data: ${new Date(task.reportDate).toLocaleDateString('pl-PL')}`, 20, y);
                    y += lineHeight * 1.5;
                });
            }
            
            // Stopka
            const finalY = Math.max(y + 20, 280);
            doc.setFontSize(10);
            doc.text(`Wygenerowano: ${new Date().toLocaleString('pl-PL')}`, 20, finalY);
            doc.text(`Utworzone przez: ${currentUser.name}`, 120, finalY);
            
            // Zapisz PDF
            const fileName = `raport_${reportType}_${fromDate}_${toDate}.pdf`;
            doc.save(fileName);
        }
        
        function getReportTypeText(type) {
            const types = {
                'summary': 'Podsumowanie',
                'detailed': 'Szczegółowy',
                'by-technician': 'Według technika',
                'by-location': 'Według lokalizacji'
            };
            return types[type] || type;
        }
        
        // Obsługa kliknięcia poza modal
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('add-option-modal');
            if (event.target === modal) {
                closeModal();
            }
        });
        
        // Obsługa klawisza Enter w modal
        document.getElementById('new-option-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                saveNewOption();
            }
        });

        // Inicjalizacja danych w localStorage
        if (!localStorage.getItem('locations')) {
            localStorage.setItem('locations', JSON.stringify(['Warszawa', 'Kraków', 'Poznań']));
        }
        if (!localStorage.getItem('techniques')) {
            localStorage.setItem('techniques', JSON.stringify(['Technika 1', 'Technika 2', 'Technika 3']));
        }

        // Funkcje do obsługi modali
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            if (modalId === 'locationModal') {
                updateLocationsList();
            } else if (modalId === 'techniqueModal') {
                updateTechniquesList();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Funkcje do zarządzania lokalizacjami
        function addNewLocation() {
            const input = document.getElementById('newLocation');
            const location = input.value.trim();
            if (location) {
                let locations = JSON.parse(localStorage.getItem('locations')) || [];
                if (!locations.includes(location)) {
                    locations.push(location);
                    localStorage.setItem('locations', JSON.stringify(locations));
                    input.value = '';
                    
                    // Aktualizuj wszystkie listy
                    updateLocationsList();
                    updateLocationSelects();
                    
                    // Zamknij modal
                    closeModal('locationModal');
                    
                    // Wybierz nową lokalizację w select
                    const locationSelect = document.getElementById('location');
                    locationSelect.value = location;
                    $(locationSelect).trigger('change');
                    
                    alert('✅ Nowa lokalizacja została dodana!');
                } else {
                    alert('Ta lokalizacja już istnieje!');
                }
            } else {
                alert('Proszę wprowadzić nazwę lokalizacji!');
            }
        }

        // Dodaj obsługę klawisza Enter dla pola lokalizacji
        document.getElementById('newLocation').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault(); // Zapobiegaj domyślnej akcji
                addNewLocation();
            }
        });

        // Funkcje do zarządzania technikami
        function addNewTechnique() {
            const input = document.getElementById('newTechnique');
            const technique = input.value.trim();
            if (technique) {
                let techniques = JSON.parse(localStorage.getItem('techniques')) || [];
                if (!techniques.includes(technique)) {
                    techniques.push(technique);
                    localStorage.setItem('techniques', JSON.stringify(techniques));
                    input.value = '';
                    
                    // Aktualizuj wszystkie listy
                    updateTechniquesList();
                    updateTechniqueSelects();
                    
                    // Zamknij modal
                    closeModal('techniqueModal');
                    
                    // Wybierz nowego technika w select
                    const technicianSelect = document.getElementById('technician');
                    technicianSelect.value = technique;
                    $(technicianSelect).trigger('change');
                    
                    alert('✅ Nowy technik został dodany!');
                } else {
                    alert('Ten technik już istnieje!');
                }
            } else {
                alert('Proszę wprowadzić nazwę technika!');
            }
        }

        // Dodaj obsługę klawisza Enter dla pola technika
        document.getElementById('newTechnique').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault(); // Zapobiegaj domyślnej akcji
                addNewTechnique();
            }
        });

        // Aktualizacja funkcji updateLocationsList
        function updateLocationsList() {
            const locations = JSON.parse(localStorage.getItem('locations')) || [];
            const list = document.getElementById('locationsList');
            if (list) {
                list.innerHTML = locations.sort().map(loc => `
                    <div class="data-item">
                        <span>${loc}</span>
                        <span class="delete-item" onclick="deleteLocation('${loc}')">&times;</span>
                    </div>
                `).join('');
            }
        }

        // Aktualizacja funkcji updateTechniquesList
        function updateTechniquesList() {
            const techniques = JSON.parse(localStorage.getItem('techniques')) || [];
            const list = document.getElementById('techniquesList');
            if (list) {
                list.innerHTML = techniques.sort().map(tech => `
                    <div class="data-item">
                        <span>${tech}</span>
                        <span class="delete-item" onclick="deleteTechnique('${tech}')">&times;</span>
                    </div>
                `).join('');
            }
        }

        // Aktualizacja funkcji updateLocationSelects
        function updateLocationSelects() {
            const locations = JSON.parse(localStorage.getItem('locations')) || [];
            const selects = document.querySelectorAll('select[data-type="location"]');
            selects.forEach(select => {
                const currentValue = select.value;
                // Wyczyść obecne opcje
                select.innerHTML = '<option value="">Wybierz lokalizację</option>';
                
                // Dodaj wszystkie lokalizacje z localStorage
                locations.sort().forEach(loc => {
                    const option = document.createElement('option');
                    option.value = loc;
                    option.textContent = loc;
                    if (currentValue === loc) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });

                // Odśwież Select2 jeśli jest zainicjalizowany
                if ($(select).data('select2')) {
                    $(select).trigger('change');
                }
            });
        }

        // Aktualizacja funkcji updateTechniqueSelects
        function updateTechniqueSelects() {
            const techniques = JSON.parse(localStorage.getItem('techniques')) || [];
            const selects = document.querySelectorAll('select[data-type="technique"]');
            selects.forEach(select => {
                const currentValue = select.value;
                // Wyczyść obecne opcje
                select.innerHTML = '<option value="">Wybierz technika</option>';
                
                // Dodaj wszystkich techników z localStorage
                techniques.sort().forEach(tech => {
                    const option = document.createElement('option');
                    option.value = tech;
                    option.textContent = tech;
                    if (currentValue === tech) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });

                // Odśwież Select2 jeśli jest zainicjalizowany
                if ($(select).data('select2')) {
                    $(select).trigger('change');
                }
            });
        }

        // Inicjalizacja Select2 dla pól wyboru
        function initializeSelects() {
            $('.select2-search').select2({
                width: '100%',
                language: {
                    noResults: function() {
                        return "Brak wyników";
                    },
                    searching: function() {
                        return "Wyszukiwanie...";
                    }
                },
                placeholder: "Zacznij pisać, aby wyszukać...",
                allowClear: true
            });
        }

        // Zamykanie modali przy kliknięciu poza nimi
        window.onclick = function(event) {
            if (event.target.className === 'modal') {
                event.target.style.display = 'none';
            }
        }

        // Dodajemy funkcję do cichego czyszczenia załączników (bez pytania)
        function silentClearFiles() {
            attachedFiles = [];
            updateFileList();
        }

        // Dodajemy funkcje do obsługi localStorage dla zadań
        function saveTasksToStorage() {
            localStorage.setItem('tasks', JSON.stringify(tasks));
            localStorage.setItem('archivedTasks', JSON.stringify(archivedTasks));
            localStorage.setItem('taskCounter', taskCounter.toString());
        }

        function loadTasksFromStorage() {
            const savedTasks = localStorage.getItem('tasks');
            const savedArchivedTasks = localStorage.getItem('archivedTasks');
            const savedCounter = localStorage.getItem('taskCounter');

            if (savedTasks) {
                tasks = JSON.parse(savedTasks);
            }
            if (savedArchivedTasks) {
                archivedTasks = JSON.parse(savedArchivedTasks);
            }
            if (savedCounter) {
                taskCounter = parseInt(savedCounter);
            }
        }

        // ==========================================
        // TUTAJ WKLEJ KONFIGURACJĘ Z FIREBASE
        // Znajdź te dane w konsoli Firebase
        // i podmień poniższe wartości
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyCpJgoQ_n9WaykZCBxDDo0uMkWukStO2JU",
            authDomain: "apka-zadania-75f6c.firebaseapp.com",
            projectId: "apka-zadania-75f6c",
            storageBucket: "apka-zadania-75f6c.firebasestorage.app",
            messagingSenderId: "85107706101",
            appId: "1:85107706101:web:39b20ed9dd7fe164859dbc"
        };
        // ==========================================
        // KONIEC KONFIGURACJI FIREBASE
        // ==========================================

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Modyfikacja funkcji saveTasksToStorage
        async function saveTasksToStorage() {
            // Zapisz lokalnie
            localStorage.setItem('tasks', JSON.stringify(tasks));
            localStorage.setItem('archivedTasks', JSON.stringify(archivedTasks));
            localStorage.setItem('taskCounter', taskCounter.toString());

            // Zapisz do Firebase
            if (currentUser) {
                try {
                    await db.collection('users').doc(currentUser.username).set({
                        tasks: tasks,
                        archivedTasks: archivedTasks,
                        taskCounter: taskCounter,
                        lastUpdate: new Date().toISOString()
                    });
                } catch (error) {
                    console.error("Błąd podczas synchronizacji z bazą danych:", error);
                }
            }
        }

        // Modyfikacja funkcji loadTasksFromStorage
        async function loadTasksFromStorage() {
            // Najpierw wczytaj dane lokalne
            const savedTasks = localStorage.getItem('tasks');
            const savedArchivedTasks = localStorage.getItem('archivedTasks');
            const savedCounter = localStorage.getItem('taskCounter');

            if (savedTasks) tasks = JSON.parse(savedTasks);
            if (savedArchivedTasks) archivedTasks = JSON.parse(savedArchivedTasks);
            if (savedCounter) taskCounter = parseInt(savedCounter);

            // Jeśli użytkownik jest zalogowany, pobierz dane z Firebase
            if (currentUser) {
                try {
                    const doc = await db.collection('users').doc(currentUser.username).get();
                    if (doc.exists) {
                        const data = doc.data();
                        tasks = data.tasks || [];
                        archivedTasks = data.archivedTasks || [];
                        taskCounter = data.taskCounter || 1;
                        
                        // Aktualizuj dane lokalne
                        localStorage.setItem('tasks', JSON.stringify(tasks));
                        localStorage.setItem('archivedTasks', JSON.stringify(archivedTasks));
                        localStorage.setItem('taskCounter', taskCounter.toString());
                    }
                } catch (error) {
                    console.error("Błąd podczas pobierania danych z bazy:", error);
                }
            }
        }

        // Rejestracja Service Worker dla PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker zarejestrowany');
                    })
                    .catch(error => {
                        console.error('Błąd rejestracji ServiceWorker:', error);
                    });
            });
        }
    </script>
</body>
</html>